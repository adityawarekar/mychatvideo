{% extends 'base/main.html' %}
{% block content %}

<div class="lobby">

    <!-- HEADER -->
    <h1>üé• MyChat</h1>
    <p>Connect with friends instantly</p>

    <!-- USERS PRESENCE (STEP 2) -->
    <div class="users">
        <h3>üë• Users</h3>

        {% if profiles %}
            <ul>
                {% for profile in profiles %}
                    <li>
                        <strong>{{ profile.user.username }}</strong>
                        {% if profile.status == 'online' %}
                            <span style="color: green;">üü¢ Online</span>
                        {% elif profile.status == 'in_call' %}
                            <span style="color: orange;">üé• In Call</span>
                        {% else %}
                            <span style="color: red;">üî¥ Offline</span>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>No other users yet</p>
        {% endif %}
    </div>

    <hr>

    <!-- ROOM FORM (STEP 3 + STEP 6 ADDED HERE) -->
    <form id="form">
        <input name="room" placeholder="Enter Room Name" required />

        <label>
            <input type="checkbox" name="private" />
            Private Room
        </label>

        <input
            name="password"
            placeholder="Room Password (only for private room)"
        />

        <button type="submit">Join Room</button>
    </form>

</div>

<script>
document.getElementById('form').onsubmit = async (e) => {
    e.preventDefault()

    const room = e.target.room.value.toUpperCase()
    const isPrivate = e.target.private.checked
    const password = e.target.password.value

    try {
        const params = new URLSearchParams({
            channel: room,
            private: isPrivate,
            password: password
        })

        const roomRes = await fetch(`/create_room/?${params.toString()}`)

        if (!roomRes.ok) {
            alert("‚ùå Wrong password or room error")
            return
        }

        const tokenRes = await fetch(`/get_token/?channel=${room}`)
        const data = await tokenRes.json()

        sessionStorage.setItem('room', room)
        sessionStorage.setItem('uid', data.uid)
        sessionStorage.setItem('token', data.token)

        window.location.href = `/room/?room=${room}`
    } catch (err) {
        alert("Something went wrong")
    }
}
</script>
{% endblock %}
